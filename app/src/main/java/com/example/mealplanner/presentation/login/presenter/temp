package com.example.mealplanner.presentation.login.presenter;

import static android.provider.Settings.System.getString;


import android.content.Context;
import android.os.CancellationSignal;

import androidx.credentials.CredentialManager;
import androidx.credentials.CredentialManagerCallback;
import androidx.credentials.GetCredentialRequest;

import com.example.mealplanner.R;
import com.example.mealplanner.presentation.login.view.LogInScreen;
import com.example.mealplanner.presentation.login.view.LogInView;
import com.google.android.libraries.identity.googleid.GetGoogleIdOption;
import com.google.firebase.auth.FirebaseAuth;

import java.util.concurrent.Executors;

public class LogInPresenterIMP implements LogInPresenter {

    private FirebaseAuth auth;
    private LogInView view;
    private CredentialManager credentialManager;


    public LogInPresenterIMP(LogInScreen logInScreen, Context context) {
        auth = FirebaseAuth.getInstance();
        view = logInScreen;
        credentialManager = CredentialManager.create(context);

    }

    @Override
    public void logInUser(String email, String pass) {
        auth.signInWithEmailAndPassword(email, pass).addOnCompleteListener(task -> {
            if (task.isSuccessful()) {
                view.onSuccess(auth.getCurrentUser());
            }else{
                view.onFailed();
            }
        });
    }

    @Override
    public void logInUserWithGoogle() {
        GetGoogleIdOption googleIdOption = new GetGoogleIdOption.Builder()
                .setFilterByAuthorizedAccounts(false)
                .setServerClientId(getString(R.string.default_web_client_id))
                .setAutoSelectEnabled(true)
                .build();

        GetCredentialRequest request = new GetCredentialRequest.Builder()
                .addCredentialOption(googleIdOption)
                .build();

        CancellationSignal cancellationSignal = new CancellationSignal();

        credentialManager.getCredentialAsync(
                this,
                request,
                cancellationSignal,
                Executors.newSingleThreadExecutor(),
                new CredentialManagerCallback<>() {
                    @Override
                    public void onResult(GetCredentialResponse result) {
                        runOnUiThread(() -> handleSignInResult(result));
                    }

                    @Override
                    public void onError(@NonNull GetCredentialException e) {
                        runOnUiThread(() -> handleSignInError(e));
                    }
                }
        );
    }

    private void handleSignInResult(GetCredentialResponse response) {
        Credential credential = response.getCredential();

        if (credential instanceof CustomCredential) {
            CustomCredential customCredential = (CustomCredential) credential;

            if (GoogleIdTokenCredential.TYPE_GOOGLE_ID_TOKEN_CREDENTIAL.equals(customCredential.getType())) {
                try {
                    GoogleIdTokenCredential googleIdTokenCredential =
                            GoogleIdTokenCredential.createFrom(customCredential.getData());

                    String idToken = googleIdTokenCredential.getIdToken();

                    Log.d(TAG, "Google Sign-In successful");
                    Log.d(TAG, "User Email: " + googleIdTokenCredential.getEmail());
                    Log.d(TAG, "Display Name: " + googleIdTokenCredential.getDisplayName());

                    // Authenticate with Firebase using the ID token
                    firebaseAuthWithGoogle(idToken);

                } catch (Exception e) {
                    Log.e(TAG, "Error extracting Google ID token", e);
                    showLoading(false);
                    Toast.makeText(this, "Failed to process Google Sign-In", Toast.LENGTH_SHORT).show();
                }
            } else {
                Log.e(TAG, "Unexpected credential type: " + customCredential.getType());
                showLoading(false);
                Toast.makeText(this, "Unexpected credential type", Toast.LENGTH_SHORT).show();
            }
        } else {
            Log.e(TAG, "Credential is not a CustomCredential");
            showLoading(false);
            Toast.makeText(this, "Invalid credential type", Toast.LENGTH_SHORT).show();
        }
    }

    private void handleSignInError(GetCredentialException e) {
        showLoading(false);
        Log.e(TAG, "Google Sign-In error", e);

        String errorMessage;

        if (e instanceof NoCredentialException) {
            errorMessage = "No Google accounts found on this device. Please add a Google account in Settings.";
        } else if (e.getMessage() != null && e.getMessage().contains("User cancelled")) {
            errorMessage = "Sign-in cancelled";
        } else {
            errorMessage = "Google Sign-In failed: " + e.getMessage();
        }

        Toast.makeText(this, errorMessage, Toast.LENGTH_LONG).show();
    }


    private void firebaseAuthWithGoogle(String idToken) {
        AuthCredential credential = GoogleAuthProvider.getCredential(idToken, null);

        // Sign in to Firebase with the credential
        mAuth.signInWithCredential(credential)
                .addOnCompleteListener(this, task -> {
                    showLoading(false);

                    if (task.isSuccessful()) {
                        Log.d(TAG, "signInWithCredential:success");
                        if (mAuth.getCurrentUser() == null)
                            return;

                        Log.d(TAG, "User email: " + mAuth.getCurrentUser().getEmail());

                        // Save login state and navigate
                        saveLoginState();
                        navigateToHome();
                    } else {
                        Log.w(TAG, "signInWithCredential:failure", task.getException());
                        Toast.makeText(this, "Firebase authentication failed: " +
                                Objects.requireNonNull(task.getException()).getMessage(), Toast.LENGTH_LONG).show();
                    }
                });
    }


}
